// Copyright 2025 Assistance Micro Design
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

use crate::mcp::MCPManager;
use crate::models::{AgentConfig, Lifecycle};
use async_trait::async_trait;
use std::sync::Arc;

/// Task represents a request to the agent
#[derive(Debug, Clone)]
pub struct Task {
    /// Unique task identifier
    pub id: String,
    /// Task description
    pub description: String,
    /// Additional context
    pub context: serde_json::Value,
}

/// Report generated by an agent (Markdown format)
#[derive(Debug, Clone)]
pub struct Report {
    /// Task identifier (used in future phases for tracking)
    #[allow(dead_code)]
    pub task_id: String,
    /// Report status
    pub status: ReportStatus,
    /// Full markdown report content (for DB/export)
    pub content: String,
    /// Pure LLM response content only (for display in chat bubble)
    pub response: String,
    /// Execution metrics
    pub metrics: ReportMetrics,
    /// System prompt used (for persistence on first message)
    /// Only populated on first message of a workflow
    pub system_prompt: Option<String>,
    /// Tools JSON definition (for persistence on first message)
    /// Only populated on first message of a workflow
    /// Reserved for future use (caching tool definitions between messages)
    #[allow(dead_code)]
    pub tools_json: Option<serde_json::Value>,
}

/// Report status
#[derive(Debug, Clone)]
#[allow(dead_code)]
pub enum ReportStatus {
    Success,
    Failed,
    Partial,
}

/// Intermediate reasoning step data for persistence
#[derive(Debug, Clone)]
pub struct ReasoningStepData {
    /// Content of the reasoning step
    pub content: String,
    /// Duration in milliseconds (from start of execution to this step)
    pub duration_ms: u64,
}

/// Detailed tool execution data for persistence
#[derive(Debug, Clone)]
pub struct ToolExecutionData {
    /// Tool type ("local" or "mcp")
    pub tool_type: String,
    /// Tool name (e.g., "MemoryTool", "find_symbol")
    pub tool_name: String,
    /// MCP server name (only for MCP tools)
    pub server_name: Option<String>,
    /// Input parameters as JSON
    pub input_params: serde_json::Value,
    /// Output result as JSON
    pub output_result: serde_json::Value,
    /// Whether execution was successful
    pub success: bool,
    /// Error message if failed
    pub error_message: Option<String>,
    /// Duration in milliseconds
    pub duration_ms: u64,
    /// Iteration number in the tool loop
    pub iteration: u32,
}

/// Metrics collected during task execution
#[derive(Debug, Clone)]
pub struct ReportMetrics {
    /// Duration in milliseconds
    pub duration_ms: u64,
    /// Input tokens consumed
    pub tokens_input: usize,
    /// Output tokens generated
    pub tokens_output: usize,
    /// Tools used (names only, for backward compatibility)
    pub tools_used: Vec<String>,
    /// MCP calls made (names only, for backward compatibility)
    pub mcp_calls: Vec<String>,
    /// Detailed tool execution data for persistence
    pub tool_executions: Vec<ToolExecutionData>,
    /// Intermediate reasoning steps collected during execution
    pub reasoning_steps: Vec<ReasoningStepData>,
}

/// Agent trait - unified interface for all agents
#[async_trait]
#[allow(dead_code)]
pub trait Agent: Send + Sync {
    /// Executes a task and returns a report
    ///
    /// This is the legacy method without MCP support.
    /// New implementations should prefer `execute_with_mcp`.
    async fn execute(&self, task: Task) -> anyhow::Result<Report>;

    /// Executes a task with access to MCP tools
    ///
    /// This method allows the agent to call MCP tools during execution.
    /// The default implementation delegates to `execute()` for backward compatibility.
    ///
    /// # Arguments
    /// * `task` - The task to execute
    /// * `mcp_manager` - Optional MCP manager for tool invocation
    ///
    /// # Returns
    /// A report containing the execution results and metrics
    async fn execute_with_mcp(
        &self,
        task: Task,
        _mcp_manager: Option<Arc<MCPManager>>,
    ) -> anyhow::Result<Report> {
        // Default implementation for backward compatibility
        self.execute(task).await
    }

    /// Returns agent capabilities
    fn capabilities(&self) -> Vec<String>;

    /// Returns lifecycle type
    fn lifecycle(&self) -> Lifecycle;

    /// Returns available tools
    fn tools(&self) -> Vec<String>;

    /// Returns required MCP servers
    fn mcp_servers(&self) -> Vec<String>;

    /// Returns system prompt
    fn system_prompt(&self) -> String;

    /// Returns agent configuration
    fn config(&self) -> &AgentConfig;
}

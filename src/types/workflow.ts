/**
 * Copyright 2025 Assistance Micro Design
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// Copyright 2025 Zileo-Chat-3 Contributors
// SPDX-License-Identifier: Apache-2.0

import type { Message } from './message';
import type { ThinkingStep } from './thinking';
import type { ToolExecution, WorkflowToolExecution } from './tool';

/**
 * Workflow status representing the current state of a workflow
 */
export type WorkflowStatus = 'idle' | 'running' | 'completed' | 'error';

/**
 * Workflow entity representing a user workflow
 */
export interface Workflow {
  /** Unique identifier */
  id: string;
  /** Workflow name */
  name: string;
  /** Associated agent ID */
  agent_id: string;
  /** Current status */
  status: WorkflowStatus;
  /** Creation timestamp */
  created_at: Date;
  /** Last update timestamp */
  updated_at: Date;
  /** Completion timestamp (if completed) */
  completed_at?: Date;
  /** Cumulative input tokens for this workflow */
  total_tokens_input: number;
  /** Cumulative output tokens for this workflow */
  total_tokens_output: number;
  /** Cumulative cost for this workflow (USD) */
  total_cost_usd: number;
  /** Model ID used (for context_window lookup) */
  model_id?: string;
  /** Current context size (last API call context window usage) */
  current_context_tokens: number;
}

/**
 * Result of a workflow execution
 */
export interface WorkflowResult {
  /** Markdown report generated by the agent */
  report: string;
  /** Execution metrics */
  metrics: WorkflowMetrics;
  /** List of tools used during execution */
  tools_used: string[];
  /** List of MCP calls made during execution */
  mcp_calls: string[];
  /** Detailed tool execution data for persistence and display */
  tool_executions: WorkflowToolExecution[];
}

/**
 * Metrics collected during workflow execution
 */
export interface WorkflowMetrics {
  /** Duration in milliseconds */
  duration_ms: number;
  /** Input tokens consumed */
  tokens_input: number;
  /** Output tokens generated */
  tokens_output: number;
  /** Cost in USD */
  cost_usd: number;
  /** LLM provider used */
  provider: string;
  /** Model used */
  model: string;
}

/**
 * Complete workflow state for recovery after restart.
 *
 * Contains all data needed to fully restore a workflow session:
 * - The workflow metadata
 * - All conversation messages
 * - Tool execution history
 * - Thinking/reasoning steps
 *
 * Used by `load_workflow_full_state` command for Phase 5: Complete State Recovery.
 */
export interface WorkflowFullState {
  /** The workflow entity with metadata */
  workflow: Workflow;
  /** All messages in chronological order */
  messages: Message[];
  /** Tool execution history */
  tool_executions: ToolExecution[];
  /** Thinking/reasoning steps */
  thinking_steps: ThinkingStep[];
}

/**
 * Token display data for real-time monitoring.
 *
 * Used by the TokenDisplay component to show context usage,
 * token counts, cost estimation, and generation speed.
 */
export interface TokenDisplayData {
  /** Input tokens for current message/streaming */
  tokens_input: number;
  /** Output tokens for current message/streaming */
  tokens_output: number;
  /** Cumulative input tokens for workflow */
  cumulative_input: number;
  /** Cumulative output tokens for workflow */
  cumulative_output: number;
  /** Context window maximum from model */
  context_max: number;
  /** Estimated cost for current message (USD) */
  cost_usd: number;
  /** Cumulative cost for workflow (USD) */
  cumulative_cost_usd: number;
  /** Token generation speed (tokens/second) - only during streaming */
  speed_tks?: number;
  /** Whether currently streaming */
  is_streaming: boolean;
}
